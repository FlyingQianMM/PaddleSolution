# 4 Mask-RCNN调优

## 目录
* [4.1 提升精度](#41-提升精度)
* [4.2 提升召回率](#42-提升召回率)
* [4.3 降低误检率](#43-降低误检率)
* [4.4 提升预测速度](#44-提升预测速度)

## 4.1 提升精度

可以采用以下策略调整训练时的参数，以期获得精度或效率的提升。

(1) 使用更大的主干网络

&emsp;&emsp;使用更大的主干网络(比如SENet154-vd-FPN)取得的精度会更高，但此时模型的参数量变多，运行速度变慢。且需注意的时候，在数量较少的数据集上使用大的主干网络容易导致模型过拟合，此时的精度可能得不到提升。

(2) 调整输入图像的大小

&emsp;&emsp;参数[`target_size`](https://github.com/PaddlePaddle/models/blob/e0f58e800069da7fdb70e2113b6383683d82bd43/PaddleCV/PaddleDetection/ppdet/data/data_feed.py#L554)默认设置为800，[`max_size`](https://github.com/PaddlePaddle/models/blob/e0f58e800069da7fdb70e2113b6383683d82bd43/PaddleCV/PaddleDetection/ppdet/data/data_feed.py#L555)默认设置为1333，这两个参数表示将图片的短边缩放至800，长边按短边的缩放比例做同样的缩放，如果缩放后的长边大于1333，则长边缩放至1333，短边按长边的缩放比例做同样的缩放。图片完成缩放之后才会被输入给网络进行训练或预测。

&emsp;&emsp;如果数据集中目标都比较小，在显存容量允许的前提下，可以在尝试将参数`target_size`和`max_size`调大，重新训练后精度会得到提升，但运行速度会变慢。

&emsp;&emsp;此外，也可以根据实际情况设置参数`target_size`和`max_size`。例如，数据集中的图片大小基本是370x1200，那么可以参数`target_size`设置成400。以[mask_rcnn_r50_vd_fpn.yml]()为例，在该文件中添加参数`target_size`和`max_size`：（#这里需测试）
```
MaskRCNNTrainFeed:
  # batch size per device
  batch_size: 1
  dataset:
    dataset_dir: dataset/coco
    image_dir: train2017
    annotation: annotations/instances_train2017.json
  batch_transforms:
  - !PadBatch
    pad_to_stride: 32
  num_workers: 2

MaskRCNNEvalFeed:
  batch_size: 1
  dataset:
    dataset_dir: dataset/coco
    annotation: annotations/instances_val2017.json
    image_dir: val2017
  batch_transforms:
  - !PadBatch
    pad_to_stride: 32
  num_workers: 2

MaskRCNNTestFeed:
  batch_size: 1
  dataset:
    annotation: annotations/instances_val2017.json
  batch_transforms:
  - !PadBatch
    pad_to_stride: 32
  num_workers: 2
```
(3) 调整预设框的大小

## 4.2 提升召回率

&emsp;&emsp;调低训练时划分正样本所需要的阈值，能提升模型的召回率，但可能会导致误检率的升高。
* `rpn_positive_overlap`为候选框生成网络中划分正样本所用到的阈值，默认值为0.7，可以将该值调低但不要低于`rpn_negative_overlap`的设定值。

* `fg_thresh`为三个分支网络中划分正样本所用到的阈值，默认值为0.5，可以将该值调低但不要低于`bg_thresh_hi`的设定值。

## 4.3 降低误检率

&emsp;&emsp;调高划分负样本所需要的阈值，能降低模型的误检率，但可能会导致召回率的降低。

* `rpn_negative_overlap`为候选框生成网络中划分负样本所用到的阈值，默认值为0.3，可以将该值调高但不要高于`rpn_positive_overlap`的设定值。

* `bg_thresh_hi`为三个分支网络中划分负样本所用到的阈值，默认值为0.5，可以将该值调高但不要高于`fg_thresh`的设定值。


## 4.4 提升预测速度

&emsp;&emsp;在预测或评估阶段，可以减少候选框的数量，预测速度会得到提升可能会导致精度降低。默认情况下，test_proposal/post_nms_top_n被设置为1000，可以修改该值，例如设置为300。
